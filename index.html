<!DOCTYPE html>
<html>
<head>
    <title>Rota PlanlayÄ±cÄ±</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        #container { 
            max-width: 700px; 
            margin: auto; 
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        h1 { 
            color: #667eea; 
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 25px;
            font-size: 0.9em;
        }
        .mode-switch {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            background: #f5f5f5;
            padding: 5px;
            border-radius: 10px;
        }
        .mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .mode-btn.active {
            background: #667eea;
            color: white;
        }
        .panel {
            display: none;
        }
        .panel.active {
            display: block;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        input[type="text"] { 
            flex: 1;
            padding: 12px; 
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        button { 
            padding: 12px 20px; 
            cursor: pointer;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-add { background: #667eea; color: white; }
        .btn-optimize { background: #4CAF50; color: white; width: 100%; font-size: 16px; margin-top: 15px; }
        .btn-clear { background: #f44336; color: white; width: 100%; margin-top: 10px; }
        .btn-share { background: #2196f3; color: white; width: 100%; margin-top: 10px; }
        ul { list-style-type: none; padding: 0; margin: 15px 0; }
        li { 
            background: #f8f9fa; 
            padding: 12px 15px; 
            margin-bottom: 8px; 
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }
        .remove-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }
        .warning-box {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ff9800;
        }
        .success-box {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
        }
        .error-box {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #f44336;
        }
        .loading {
            text-align: center;
            padding: 30px;
            color: #667eea;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .route-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }
        .route-list li {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .route-list li.current {
            border-left-color: #667eea;
            background: #e8eaf6;
            font-weight: 600;
        }
        .route-number {
            background: #667eea;
            color: white;
            min-width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        .route-list li.current .route-number {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .maps-link {
            display: block;
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 15px;
            text-align: center;
        }
        .maps-link:hover {
            background: #45a049;
        }
        #share-section {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        #share-section h3 {
            color: #2e7d32;
            margin-top: 0;
        }
        .share-url {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #4CAF50;
            border-radius: 5px;
            font-size: 12px;
            font-family: monospace;
        }
        #qrcode {
            text-align: center;
            margin: 15px 0;
        }
    </style>
</head>
<body>

    <div id="container">
        <h1>ğŸš— Rota PlanlayÄ±cÄ±</h1>
        <div class="subtitle">AkÄ±llÄ± Kurye Rota Sistemi</div>

        <!-- Mod SeÃ§imi -->
        <div class="mode-switch">
            <button class="mode-btn active" onclick="switchMode('operator')">
                ğŸ‘¨â€ğŸ’¼ OperatÃ¶r Modu
            </button>
            <button class="mode-btn" onclick="switchMode('courier')">
                ğŸš— Kurye Modu
            </button>
        </div>

        <!-- OPERATÃ–R PANELÄ° -->
        <div id="operator-panel" class="panel active">
            <div class="info-box">
                <strong>ğŸ“ OperatÃ¶r:</strong> TÃ¼m adresleri ekleyin, sonra "PaylaÅŸ" butonuna basÄ±n.
            </div>
            
            <!-- Lokal dosya uyarÄ±sÄ± -->
            <div id="local-file-warning" style="display: none;" class="warning-box">
                <strong>âš ï¸ UYARI: Lokal Dosya AÃ§tÄ±nÄ±z!</strong>
                <p style="margin: 10px 0 0 0; font-size: 0.9em;">
                    Bu dosyayÄ± bilgisayarÄ±nÄ±zdan aÃ§Ä±yorsunuz. PaylaÅŸÄ±m linkleri Ã§alÄ±ÅŸmayacaktÄ±r!<br>
                    <strong>Ã‡Ã¶zÃ¼m:</strong> <a href="https://xati7x.github.io/rota-planlayici/" style="color: #ff9800; font-weight: 600;">Bu linki kullanÄ±n â†’</a>
                </p>
            </div>

            <div class="input-group">
                <input type="text" id="address-input" placeholder="Adres girin (Ã¶rn: Kosifler, Antalya)">
                <button class="btn-add" onclick="addAddress()">â• Ekle</button>
            </div>

            <h3>ğŸ“ Duraklar: (<span id="stop-count">0</span>)</h3>
            <ul id="address-list"></ul>

            <button class="btn-optimize" onclick="optimizeOperatorRoute()">ğŸ¯ RotayÄ± Ã–nizle</button>
            <button class="btn-share" onclick="generateShareLink()">ğŸ“± Kuryeye PaylaÅŸ</button>
            <button class="btn-clear" onclick="clearAddresses()">ğŸ—‘ï¸ TÃ¼mÃ¼nÃ¼ Temizle</button>

            <div id="operator-results"></div>
            <div id="share-section" style="display: none;"></div>
        </div>

        <!-- KURYE PANELÄ° -->
        <div id="courier-panel" class="panel">
            <div id="courier-status"></div>
            <div id="courier-results"></div>
        </div>
    </div>

    <!-- QR Kod KÃ¼tÃ¼phanesi -->
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>

    <script>
        const API_KEY = 'AIzaSyAj70WAwMKjGCCdUqyWrw2bS8hXd6iD7GU';
        const ANTALYA_CENTER = { lat: 36.8969, lng: 30.7133 };
        
        let addresses = [];
        let userLocation = null;
        let currentMode = 'operator';
        let autocomplete;

        // Sayfa yÃ¼klendiÄŸinde
        window.addEventListener('load', () => {
            // Lokal dosya kontrolÃ¼
            if (window.location.protocol === 'file:') {
                document.getElementById('local-file-warning').style.display = 'block';
                console.warn('âš ï¸ LOKAL DOSYA TESPÄ°T EDÄ°LDÄ°! GitHub Pages linkini kullanÄ±n: https://xati7x.github.io/rota-planlayici/');
            }
            
            // URL'den adres var mÄ± kontrol et
            const urlParams = new URLSearchParams(window.location.search);
            const addressParam = urlParams.get('a');
            
            console.log('Sayfa yÃ¼klendi. URL parametresi:', addressParam);
            
            if (addressParam) {
                // Kurye moduna geÃ§
                console.log('Adres parametresi bulundu, kurye moduna geÃ§iliyor...');
                try {
                    addresses = JSON.parse(base64DecodeUnicode(addressParam));
                    console.log('Adresler decode edildi:', addresses);
                    switchMode('courier');
                    setTimeout(() => startCourierMode(), 500);
                } catch (e) {
                    console.error('Decode hatasÄ±:', e);
                    switchMode('courier');
                    showCourierError('Adres bilgisi hatalÄ±. LÃ¼tfen operatÃ¶rden yeni link isteyin.');
                }
            } else {
                console.log('URL parametresi yok, operatÃ¶r modunda baÅŸlÄ±yor.');
            }
        });

        // Google Maps yÃ¼klendiÄŸinde
        function initMap() {
            const input = document.getElementById('address-input');
            autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['establishment', 'geocode'],
                componentRestrictions: { country: 'tr' },
                fields: ['formatted_address', 'geometry', 'name']
            });

            const circle = new google.maps.Circle({
                center: ANTALYA_CENTER,
                radius: 25000
            });
            autocomplete.setBounds(circle.getBounds());
        }

        // Mod deÄŸiÅŸtir
        function switchMode(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
            
            if (mode === 'operator') {
                document.querySelectorAll('.mode-btn')[0].classList.add('active');
                document.getElementById('operator-panel').classList.add('active');
            } else {
                document.querySelectorAll('.mode-btn')[1].classList.add('active');
                document.getElementById('courier-panel').classList.add('active');
            }
        }

        // Adres ekle
        function addAddress() {
            const input = document.getElementById('address-input');
            const address = input.value.trim();
            
            if (address) {
                let finalAddress = address;
                if (!address.toLowerCase().includes('antalya')) {
                    finalAddress = address + ', Antalya';
                }
                
                addresses.push(finalAddress);
                renderAddressList();
                input.value = '';
                input.focus();
            }
        }

        // Adres listesini gÃ¶ster
        function renderAddressList() {
            const list = document.getElementById('address-list');
            const count = document.getElementById('stop-count');
            
            list.innerHTML = '';
            count.textContent = addresses.length;
            
            addresses.forEach((addr, index) => {
                const li = document.createElement('li');
                const span = document.createElement('span');
                span.textContent = `${index + 1}. ${addr}`;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = 'âœ•';
                removeBtn.onclick = () => removeAddress(index);
                
                li.appendChild(span);
                li.appendChild(removeBtn);
                list.appendChild(li);
            });
        }

        // Adres sil
        function removeAddress(index) {
            addresses.splice(index, 1);
            renderAddressList();
        }

        // TÃ¼mÃ¼nÃ¼ temizle
        function clearAddresses() {
            if (confirm('TÃ¼m adresleri silmek istediÄŸinize emin misiniz?')) {
                addresses = [];
                renderAddressList();
                document.getElementById('operator-results').innerHTML = '';
                document.getElementById('share-section').style.display = 'none';
            }
        }

        // OperatÃ¶r rotasÄ±nÄ± Ã¶nizle (KONUM BAZLI DEÄÄ°L!)
        function optimizeOperatorRoute() {
            if (addresses.length < 2) {
                alert('âš ï¸ En az 2 adres eklemelisiniz.');
                return;
            }

            const resultsDiv = document.getElementById('operator-results');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Rota hesaplanÄ±yor...</p></div>';

            console.log('OperatÃ¶r rotasÄ± hesaplanÄ±yor (adres sÄ±rasÄ±na gÃ¶re)...');
            console.log('Adresler:', addresses);

            // OPERATÃ–R MODU: Sadece girilen sÄ±rayla rotayÄ± hesapla
            // Konum optimizasyonu YOK
            optimizeRoute(addresses, null, false, (result) => {
                if (result.success) {
                    displayOperatorRoute(result);
                } else {
                    resultsDiv.innerHTML = `<div class="error-box">âŒ ${result.error}</div>`;
                }
            });
        }

        // OperatÃ¶r sonucunu gÃ¶ster
        function displayOperatorRoute(result) {
            const resultsDiv = document.getElementById('operator-results');
            
            let html = '<div class="success-box">';
            html += '<h3>âœ… Rota Ã–nizlemesi</h3>';
            html += `<p><strong>ğŸ“ Mesafe:</strong> ${result.distance} km<br>`;
            html += `<strong>â±ï¸ SÃ¼re:</strong> ${result.duration} dakika</p>`;
            html += '<ol class="route-list">';
            result.route.forEach((addr, index) => {
                html += `<li><div class="route-number">${index + 1}</div><div>${addr}</div></li>`;
            });
            html += '</ol>';
            html += `<a href="${result.mapsUrl}" target="_blank" class="maps-link">ğŸ“± Google Haritalar'da AÃ§</a>`;
            html += '</div>';
            
            resultsDiv.innerHTML = html;
        }

        // TÃ¼rkÃ§e karakter destekli base64 encode
        function base64EncodeUnicode(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => {
                return String.fromCharCode('0x' + p1);
            }));
        }

        // TÃ¼rkÃ§e karakter destekli base64 decode
        function base64DecodeUnicode(str) {
            return decodeURIComponent(atob(str).split('').map((c) => {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }

        // PaylaÅŸÄ±m linki oluÅŸtur
        function generateShareLink() {
            if (addresses.length < 2) {
                alert('âš ï¸ En az 2 adres eklemelisiniz.');
                return;
            }

            try {
                const encoded = base64EncodeUnicode(JSON.stringify(addresses));
                
                // GitHub Pages URL'i (sabit)
                const GITHUB_URL = 'https://xati7x.github.io/rota-planlayici/';
                
                // EÄŸer localhost veya file:// ise GitHub URL kullan, deÄŸilse mevcut URL
                let baseUrl;
                if (window.location.protocol === 'file:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    baseUrl = GITHUB_URL;
                    console.log('âš ï¸ Lokal dosya tespit edildi, GitHub URL kullanÄ±lÄ±yor:', GITHUB_URL);
                } else {
                    baseUrl = window.location.origin + window.location.pathname;
                }
                
                const shareUrl = `${baseUrl}?a=${encoded}`;
                
                console.log('PaylaÅŸÄ±m linki oluÅŸturuldu:', shareUrl);
                console.log('Adresler:', addresses);

                const shareSection = document.getElementById('share-section');
                shareSection.style.display = 'block';
                
                let html = '<h3>ğŸ“± Kuryeye GÃ¶nder</h3>';
                
                // Lokal dosya uyarÄ±sÄ±
                if (window.location.protocol === 'file:') {
                    html += '<div class="warning-box" style="margin-bottom: 15px;">';
                    html += '<p style="margin: 0;"><strong>âš ï¸ DÄ°KKAT!</strong></p>';
                    html += '<p style="margin: 5px 0 0 0; font-size: 0.9em;">Lokal dosyayÄ± aÃ§Ä±yorsunuz! Bunun yerine ÅŸu linki kullanÄ±n:<br>';
                    html += '<a href="https://xati7x.github.io/rota-planlayici/" target="_blank" style="color: #ff9800; font-weight: 600;">https://xati7x.github.io/rota-planlayici/</a></p>';
                    html += '</div>';
                }
                
                html += '<p><strong>YÃ¶ntem 1: Link Kopyala</strong></p>';
                html += `<input type="text" class="share-url" value="${shareUrl}" readonly onclick="this.select()">`;
                html += `<button class="btn-share" onclick="copyShareLink('${shareUrl}')">ğŸ“‹ Linki Kopyala</button>`;
                
                html += '<p style="margin-top: 20px;"><strong>YÃ¶ntem 2: QR Kod</strong></p>';
                html += '<div id="qrcode"></div>';
                
                html += '<div class="info-box" style="margin-top: 20px;">';
                html += '<p style="margin: 0;"><strong>â„¹ï¸ NasÄ±l Ã‡alÄ±ÅŸÄ±r?</strong></p>';
                html += '<p style="margin: 10px 0 0 0; font-size: 0.9em;">Kurye bu linki aÃ§tÄ±ÄŸÄ±nda, <strong>kendi konumuna gÃ¶re</strong> en yakÄ±n duraktan baÅŸlayacak ÅŸekilde rota otomatik optimize edilir.</p>';
                html += '</div>';
                
                shareSection.innerHTML = html;
                
                setTimeout(() => {
                    new QRCode(document.getElementById("qrcode"), {
                        text: shareUrl,
                        width: 200,
                        height: 200
                    });
                }, 100);
            } catch (error) {
                alert('âŒ Link oluÅŸturulurken hata: ' + error.message);
                console.error('Share link error:', error);
            }
        }

        // Linki kopyala
        function copyShareLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('âœ… Link kopyalandÄ±! Kuryeye WhatsApp, SMS veya e-posta ile gÃ¶nderebilirsiniz.');
            }).catch(() => {
                alert('âŒ Kopyalama baÅŸarÄ±sÄ±z. LÃ¼tfen manuel olarak kopyalayÄ±n.');
            });
        }

        // KURYE MODU BAÅLAT
        function startCourierMode() {
            console.log('========== KURYE MODU BAÅLATILDI ==========');
            console.log('Adres sayÄ±sÄ±:', addresses.length);
            console.log('Adresler:', addresses);
            
            const statusDiv = document.getElementById('courier-status');
            statusDiv.innerHTML = `
                <div class="info-box">
                    ğŸ“ <strong>${addresses.length} durak</strong> yÃ¼klendi.
                </div>
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Konumunuz alÄ±nÄ±yor...</p>
                    <p style="font-size: 0.8em; color: #666;">TarayÄ±cÄ±nÄ±z konum izni isteyecek...</p>
                </div>
            `;

            if (!navigator.geolocation) {
                console.error('TarayÄ±cÄ± konum servisini desteklemiyor');
                showCourierError('TarayÄ±cÄ±nÄ±z konum servisini desteklemiyor.');
                showManualRoute();
                return;
            }

            console.log('Konum izni isteniyor...');
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log('âœ… Konum alÄ±ndÄ±:', userLocation);
                    statusDiv.innerHTML = '<div class="success-box">âœ… Konumunuz alÄ±ndÄ±! En yakÄ±n duraktan baÅŸlatÄ±lÄ±yor...</div>';
                    optimizeFromUserLocation();
                },
                (error) => {
                    console.error('Konum hatasÄ±:', error);
                    let errorMsg = 'Konum izni verilmedi veya alÄ±namadÄ±.';
                    if (error.code === 1) errorMsg = 'Konum izni verilmedi.';
                    else if (error.code === 2) errorMsg = 'Konum bilgisi alÄ±namadÄ±.';
                    else if (error.code === 3) errorMsg = 'Zaman aÅŸÄ±mÄ±.';
                    
                    statusDiv.innerHTML = `<div class="warning-box">âš ï¸ ${errorMsg}<br>OperatÃ¶r rotasÄ± gÃ¶steriliyor.</div>`;
                    showManualRoute();
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 10000, 
                    maximumAge: 0 
                }
            );
        }

        // KullanÄ±cÄ± konumundan optimize et
        function optimizeFromUserLocation() {
            console.log('========== KONUM OPTÄ°MÄ°ZASYONU BAÅLIYOR ==========');
            console.log('KullanÄ±cÄ± konumu:', userLocation);
            console.log('Adresler:', addresses);
            
            const distanceService = new google.maps.DistanceMatrixService();
            
            const destinations = addresses.map(addr => addr);
            console.log('Hedef adresler:', destinations);
            
            distanceService.getDistanceMatrix({
                origins: [new google.maps.LatLng(userLocation.lat, userLocation.lng)],
                destinations: destinations,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                region: 'TR'
            }, (response, status) => {
                console.log('========== DISTANCE MATRIX YANITI ==========');
                console.log('Status:', status);
                console.log('Response:', response);
                
                if (status === 'OK' && response.rows && response.rows.length > 0) {
                    const distances = response.rows[0].elements;
                    
                    console.log('Mesafeler hesaplandÄ±:');
                    let minDistance = Infinity;
                    let closestIndex = 0;
                    let validDistances = 0;
                    
                    distances.forEach((element, index) => {
                        console.log(`  ${index + 1}. ${addresses[index]}`);
                        console.log(`     Status: ${element.status}`);
                        
                        if (element.status === 'OK') {
                            validDistances++;
                            const distKm = (element.distance.value / 1000).toFixed(1);
                            console.log(`     Mesafe: ${distKm} km`);
                            
                            if (element.distance.value < minDistance) {
                                minDistance = element.distance.value;
                                closestIndex = index;
                            }
                        } else {
                            console.log(`     HATA: Mesafe hesaplanamadÄ±`);
                        }
                    });
                    
                    if (validDistances === 0) {
                        console.error('âŒ HiÃ§bir adres iÃ§in mesafe hesaplanamadÄ±!');
                        showCourierError('Mesafe hesaplanamadÄ±. OperatÃ¶r rotasÄ± gÃ¶steriliyor.');
                        showManualRoute();
                        return;
                    }
                    
                    console.log(`âœ… En yakÄ±n durak: ${closestIndex + 1}. ${addresses[closestIndex]} (${(minDistance/1000).toFixed(1)} km)`);
                    
                    // En yakÄ±n noktadan baÅŸlayacak ÅŸekilde yeniden sÄ±rala
                    const reordered = [];
                    for (let i = closestIndex; i < addresses.length; i++) {
                        reordered.push(addresses[i]);
                    }
                    for (let i = 0; i < closestIndex; i++) {
                        reordered.push(addresses[i]);
                    }
                    
                    console.log('Yeniden sÄ±ralanmÄ±ÅŸ adresler:', reordered);
                    
                    // KURYE MODU: Waypoint optimizasyonu AÃ‡IK
                    optimizeRoute(reordered, closestIndex, true, (result) => {
                        if (result.success) {
                            displayCourierRoute(result, closestIndex);
                        } else {
                            showCourierError(result.error);
                            showManualRoute();
                        }
                    });
                } else {
                    console.error('âŒ Distance Matrix API hatasÄ±:', status);
                    console.error('Detay:', response);
                    
                    let errorMsg = 'Mesafe hesaplanamadÄ±.';
                    if (status === 'REQUEST_DENIED') {
                        errorMsg = 'API key yetkisiz. LÃ¼tfen operatÃ¶re bildirin.';
                    } else if (status === 'OVER_QUERY_LIMIT') {
                        errorMsg = 'API kullanÄ±m limiti aÅŸÄ±ldÄ±.';
                    } else if (status === 'ZERO_RESULTS') {
                        errorMsg = 'Adresler bulunamadÄ±.';
                    }
                    
                    showCourierError(errorMsg + ' OperatÃ¶r rotasÄ± gÃ¶steriliyor.');
                    showManualRoute();
                }
            });
        }

        // Rota optimizasyonu (genel fonksiyon)
        // useOptimization: true = waypoints'leri optimize et, false = girilen sÄ±rayÄ± koru
        function optimizeRoute(addressList, startIndex, useOptimization, callback) {
            const directionsService = new google.maps.DirectionsService();
            
            console.log('optimizeRoute Ã§aÄŸrÄ±ldÄ±:', {
                addressCount: addressList.length,
                startIndex: startIndex,
                useOptimization: useOptimization
            });
            
            const origin = addressList[0];
            const destination = addressList[addressList.length - 1];
            
            let waypoints = [];
            if (addressList.length > 2) {
                waypoints = addressList.slice(1, -1).map(addr => ({
                    location: addr,
                    stopover: true
                }));
            }

            const request = {
                origin: origin,
                destination: destination,
                waypoints: waypoints,
                optimizeWaypoints: useOptimization, // OperatÃ¶rde false, kuryede true
                travelMode: google.maps.TravelMode.DRIVING,
                region: 'TR'
            };

            console.log('Google Directions API Ã§aÄŸrÄ±lÄ±yor:', request);

            directionsService.route(request, (response, status) => {
                console.log('API yanÄ±tÄ±:', status);
                
                if (status === 'OK') {
                    const route = response.routes[0];
                    const optimizedOrder = route.waypoint_order;
                    
                    console.log('Optimize edilmiÅŸ sÄ±ra:', optimizedOrder);
                    
                    let totalDistance = 0;
                    let totalDuration = 0;
                    route.legs.forEach(leg => {
                        totalDistance += leg.distance.value;
                        totalDuration += leg.duration.value;
                    });

                    let finalRoute = [addressList[0]];
                    if (addressList.length > 2 && useOptimization) {
                        // Optimize edilmiÅŸ sÄ±rayÄ± kullan
                        optimizedOrder.forEach(index => {
                            finalRoute.push(addressList[index + 1]);
                        });
                    } else if (addressList.length > 2) {
                        // Girilen sÄ±rayÄ± koru
                        for (let i = 1; i < addressList.length - 1; i++) {
                            finalRoute.push(addressList[i]);
                        }
                    }
                    finalRoute.push(addressList[addressList.length - 1]);

                    console.log('Final rota:', finalRoute);

                    callback({
                        success: true,
                        route: finalRoute,
                        distance: (totalDistance / 1000).toFixed(1),
                        duration: Math.round(totalDuration / 60),
                        mapsUrl: generateGoogleMapsUrl(finalRoute)
                    });
                } else {
                    console.error('Rota hatasÄ±:', status);
                    callback({
                        success: false,
                        error: 'Rota hesaplanamadÄ±: ' + status
                    });
                }
            });
        }

        // Kurye rotasÄ±nÄ± gÃ¶ster
        function displayCourierRoute(result, startIndex) {
            const resultsDiv = document.getElementById('courier-results');
            
            let html = '<div class="success-box">';
            html += '<h3>âœ… Konumunuza Ã–zel Rota</h3>';
            html += `<p><strong>ğŸ“ Mesafe:</strong> ${result.distance} km<br>`;
            html += `<strong>â±ï¸ SÃ¼re:</strong> ${result.duration} dakika</p>`;
            html += '<ul class="route-list">';
            result.route.forEach((addr, index) => {
                const isCurrent = index === 0;
                html += `<li class="${isCurrent ? 'current' : ''}">`;
                html += `<div class="route-number">${index + 1}</div>`;
                if (index === 0) {
                    html += `<div><strong>ğŸ¯ BURADAN BAÅLAYIN</strong><br>${addr}</div>`;
                } else if (index === result.route.length - 1) {
                    html += `<div><strong>ğŸ Son Durak</strong><br>${addr}</div>`;
                } else {
                    html += `<div>${addr}</div>`;
                }
                html += '</li>';
            });
            html += '</ul>';
            html += `<a href="${result.mapsUrl}" class="maps-link">ğŸš— Navigasyonu BaÅŸlat</a>`;
            html += '</div>';
            
            resultsDiv.innerHTML = html;
        }

        // Manuel rotayÄ± gÃ¶ster (konum alÄ±namazsa)
        function showManualRoute() {
            console.log('Manuel rota gÃ¶steriliyor (konum alÄ±namadÄ±)');
            
            // Konum yok, operatÃ¶rÃ¼n sÄ±rasÄ±nÄ± kullan ama yine de optimize et
            optimizeRoute(addresses, null, true, (result) => {
                if (result.success) {
                    const resultsDiv = document.getElementById('courier-results');
                    let html = '<div class="info-box">';
                    html += '<h3>ğŸ“‹ OperatÃ¶r RotasÄ±</h3>';
                    html += '<p style="font-size: 0.9em; color: #666;">Konumunuz alÄ±namadÄ±ÄŸÄ± iÃ§in operatÃ¶rÃ¼n belirlediÄŸi rota gÃ¶steriliyor.</p>';
                    html += `<p><strong>ğŸ“ Mesafe:</strong> ${result.distance} km<br>`;
                    html += `<strong>â±ï¸ SÃ¼re:</strong> ${result.duration} dakika</p>`;
                    html += '<ul class="route-list">';
                    result.route.forEach((addr, index) => {
                        html += `<li><div class="route-number">${index + 1}</div><div>${addr}</div></li>`;
                    });
                    html += '</ul>';
                    html += `<a href="${result.mapsUrl}" class="maps-link">ğŸš— Navigasyonu BaÅŸlat</a>`;
                    html += '</div>';
                    resultsDiv.innerHTML = html;
                } else {
                    showCourierError('Rota oluÅŸturulamadÄ±: ' + result.error);
                }
            });
        }

        // Kurye hatasÄ± gÃ¶ster
        function showCourierError(message) {
            document.getElementById('courier-status').innerHTML = 
                `<div class="error-box">âŒ ${message}</div>`;
        }

        // Google Maps URL oluÅŸtur
        function generateGoogleMapsUrl(orderedAddresses) {
            const baseUrl = 'https://www.google.com/maps/dir/';
            const encodedAddresses = orderedAddresses.map(addr => encodeURIComponent(addr)).join('/');
            return baseUrl + encodedAddresses;
        }

        // Enter tuÅŸu ile adres ekle
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('address-input')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addAddress();
            });
        });

    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAj70WAwMKjGCCdUqyWrw2bS8hXd6iD7GU&libraries=places&callback=initMap"></script>
</body>
</html>
